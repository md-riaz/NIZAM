# NIZAM — Architectural Doctrine

This document codifies the non-negotiable design principles of NIZAM. Every feature, refactor, and integration decision must align with these tenets.

---

## Core Non-Negotiables

### 1. Database Is Source of Truth

All system state — tenants, extensions, DIDs, routing policies, call flows, CDRs — lives in the database. FreeSWITCH configuration is **derived**, never manually edited.

> If it's not in the database, it doesn't exist.

### 2. Dialplan Is a Compiled Artifact

The FreeSWITCH dialplan XML is generated by `DialplanCompiler` from database state. It is never hand-authored. Changes flow: **API → Database → Compiler → XML**.

### 3. API-First Always

Every operation — create, read, update, delete — is performed through the REST API. There is no admin panel that bypasses the API. No SSH-only operations. No "just edit the config file."

### 4. No Business Logic in UI

The API layer contains all business rules, validation, and authorization. Any future UI (dashboard, flow builder, admin panel) is a thin client that consumes the API. Logic duplication between API and UI is a defect.

### 5. Multi-Tenant by Default

Every resource is scoped to a tenant. Tenant isolation is enforced at the middleware, policy, and query level. There is no "single-tenant mode" — even a single-customer deployment uses the tenant model.

### 6. Event-Driven State Tracking

Call lifecycle, registration changes, and system events are captured as immutable event records. Webhooks, SSE streams, and audit logs derive from this event backbone. State is reconstructable from events.

---

## Architectural Layers

```
┌─────────────────────────────────────────────┐
│  API Layer (Controllers, Requests, Routes)  │  ← Validation, auth, rate limiting
├─────────────────────────────────────────────┤
│  Service Layer (PolicyEvaluator, Compiler)  │  ← Business logic, orchestration
├─────────────────────────────────────────────┤
│  Model Layer (Eloquent, Policies, Events)   │  ← Data access, authorization, auditing
├─────────────────────────────────────────────┤
│  Infrastructure (DB, Redis, Queue, ESL)     │  ← Persistence, caching, async processing
└─────────────────────────────────────────────┘
```

### Layer Rules

- **Controllers** validate input and delegate to models/services. No business logic.
- **Services** orchestrate cross-model operations (e.g., `DialplanCompiler`, `PolicyEvaluator`).
- **Models** own data access, relationships, casts, and audit hooks.
- **Policies** enforce authorization. Admin bypasses all. Tenant isolation is mandatory.
- **Jobs** handle async work (webhook delivery, event processing). Always idempotent.

---

## Routing Architecture

NIZAM evolves routing from simple destination mapping to programmable policy evaluation:

```
DID → destination                     (basic)
DID → time_condition → destination    (time-aware)
DID → call_routing_policy → outcome   (policy-driven)
DID → call_flow → graph execution     (programmable)
```

### Policy Engine

Policies evaluate conditions (time, caller ID, blacklist, geo prefix) and route to match/no-match destinations. Conditions are AND-evaluated. The `PolicyEvaluator` service handles runtime evaluation; the `DialplanCompiler` compiles policies into FreeSWITCH XML condition attributes.

### Call Flow Engine

Call flows define a directed graph of nodes (play_prompt, collect_input, bridge, record, webhook, api_call, branch). The compiler walks the graph sequentially, emitting FreeSWITCH XML actions. This is the foundation for a future visual flow builder.

---

## Security Principles

- **Authentication**: Laravel Sanctum bearer tokens. No session-based auth for API.
- **Authorization**: Per-resource policies with granular permissions. Admin role bypasses all.
- **Tenant Isolation**: Middleware + policy + query scoping. Cross-tenant access is a critical defect.
- **Encryption**: Webhook secrets encrypted at rest. TLS required in production.
- **Rate Limiting**: Auth endpoints throttled at 5/min. API endpoints at 60/min per user.
- **Audit Trail**: All model mutations logged with old/new values, user, IP, timestamp.

---

## Integration Doctrine

- **Webhooks** are the primary integration mechanism. Signed with HMAC-SHA256. Retry with exponential backoff (10s, 60s, 300s). Delivery attempts are logged.
- **SSE** for real-time event streaming. Supports reconnection via `Last-Event-ID`.
- **FreeSWITCH** is accessed via ESL (Event Socket Library). Never exposed publicly.
- **External systems** integrate through the REST API and webhook subscriptions. NIZAM does not embed external business logic.

---

## What NIZAM Is

NIZAM is a **programmable communications control plane**.

It is **not**:
- A FreeSWITCH UI
- A PBX management panel
- A Wazo/FusionPBX clone

It **is**:
- An API-first platform for building communications infrastructure
- A multi-tenant routing engine with policy-driven call handling
- A composable call flow execution layer
- An event-driven automation backbone

---

## Decision Framework

When evaluating a new feature or change, ask:

1. **Does it go through the API?** If not, redesign it.
2. **Is it tenant-scoped?** If not, justify why.
3. **Is the state in the database?** If not, move it there.
4. **Is the dialplan derived?** If not, make it compiled.
5. **Is it event-driven?** If state changes aren't observable, add events.
6. **Does it have tests?** If not, write them first.

---

*This document is the architectural contract. Changes to these principles require explicit justification and team consensus.*
